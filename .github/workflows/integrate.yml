name: "integrate"

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: self-hosted
    steps:
      - name: checkout repo
        uses: actions/checkout@v2.4.0

      - name: test
        run: |
          git secret reveal
          docker-compose up --build -d
          docker-compose exec -T portfolio-site_client_1 npm run ops:test

  teardown:
    runs-on: self-hosted
    if: ${{ always() }}
    needs: [run-tests]
    steps:
      - name: teardown
        run:
          docker-compose down